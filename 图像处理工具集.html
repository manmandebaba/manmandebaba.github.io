<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图像处理工具集 - 图标提取与图片切分</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --secondary-color: #10b981;
            --secondary-hover: #059669;
            --accent-color: #8b5cf6;
        }
        
        .result-icon {
            transition: all 0.3s ease;
        }
        .result-icon:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* 图片切分器样式 */
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 25px;
        }
        .upload-area:hover {
            background-color: #f8fafc;
            border-color: #2980b9;
        }
        .preview-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            height: 400px;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            background-color: #f9f9f9;
            margin-bottom: 25px;
            position: relative;
            user-select: none;
        }
        #previewCanvas {
            max-width: 100%;
            max-height: 100%;
            display: none;
            object-fit: contain;
            align-self: flex-start;
            justify-self: flex-start;
        }
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .grid-line {
            position: absolute;
            background-color: rgba(52, 152, 219, 0.6);
            transition: background-color 0.3s ease;
        }
        .grid-line.draggable {
            pointer-events: auto;
            cursor: col-resize;
            z-index: 10;
        }
        .grid-line.draggable.horizontal {
            cursor: row-resize;
        }
        .grid-line.draggable:hover, .grid-line.draggable.dragging {
            background-color: rgba(231, 76, 60, 0.8);
            width: 8px !important;
            height: 8px !important;
        }
        .grid-line.horizontal.draggable:hover, .grid-line.horizontal.draggable.dragging {
            width: 100% !important;
            height: 8px !important;
        }
        .grid-line.vertical.draggable:hover, .grid-line.vertical.draggable.dragging {
            width: 8px !important;
            height: 100% !important;
        }
        .tiles-preview-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            height: 300px;
            background-color: #f9f9f9;
            margin-top: 20px;
            position: relative;
        }
        .tiles-preview-content {
            padding: 10px;
            height: calc(100% - 50px);
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            align-content: flex-start;
        }
        .tile-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 160px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tile-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            border-color: #3498db;
        }
        .tile {
            width: 100%;
            height: 100px;
            object-fit: contain;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .tile-info {
            font-size: 0.75rem;
            text-align: center;
            color: #666;
            margin-top: 8px;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* 图片网格切分器样式 */
        .split-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 30px;
        }
        .split-preset-btn {
            padding: 12px 18px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            flex: 1;
            min-width: 120px;
            position: relative;
        }
        .split-preset-btn:hover {
            background: #e9ecef;
            border-color: #ced4da;
            transform: translateY(-2px);
        }
        .split-preset-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-hover);
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.2);
        }
        .split-preset-btn.split-mode {
            background: #e8f4fc;
            border-color: #a5d8ff;
        }
        .split-preset-btn.split-mode.active {
            background: var(--secondary-color);
            border-color: var(--secondary-hover);
        }
        .split-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #eee;
        }
        .split-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 150px;
        }
        .split-control label {
            font-weight: 600;
            color: #2c3e50;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .slider-value {
            font-weight: 700;
            color: var(--primary-color);
            min-width: 30px;
            text-align: center;
        }
        .range-slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #dfe6e9;
            outline: none;
            -webkit-appearance: none;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .split-info {
            background-color: #f0f7ff;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-top: 20px;
            border-radius: 6px;
            font-size: 0.95rem;
            color: #2c3e50;
        }
        .split-images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .split-image {
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s;
            cursor: pointer;
            width: 150px;
        }
        .split-image:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .split-image img {
            display: block;
            width: 100%;
            height: auto;
        }
        
        /* 工具卡片样式 */
        .tool-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }
        .tool-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .section-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title i {
            color: var(--primary-color);
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .preview-container {
                height: 300px;
            }
            .tiles-preview-container {
                height: 250px;
            }
            .split-preset-btn {
                min-width: calc(50% - 12px);
                padding: 10px 12px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 头部 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 mb-2">
                <i class="fas fa-tools mr-2"></i>图像处理工具集
            </h1>
            <p class="text-gray-600 text-lg">一站式图像处理解决方案：网站图标提取、图片网格切分、自定义图片分割</p>
        </header>

        <!-- 标签导航 -->
        <div class="bg-white rounded-xl shadow-lg mb-8 overflow-hidden">
            <div class="flex border-b border-gray-200 overflow-x-auto">
                <button id="tabFavicon" class="tab-btn flex-1 py-4 font-medium text-gray-700 hover:bg-gray-50 whitespace-nowrap active" data-tab="favicon">
                    <i class="fas fa-icons mr-2"></i>网站图标提取
                </button>
                <button id="tabSplitter" class="tab-btn flex-1 py-4 font-medium text-gray-700 hover:bg-gray-50 whitespace-nowrap" data-tab="splitter">
                    <i class="fas fa-cut mr-2"></i>高级图片切分
                </button>
                <button id="tabGrid" class="tab-btn flex-1 py-4 font-medium text-gray-700 hover:bg-gray-50 whitespace-nowrap" data-tab="grid">
                    <i class="fas fa-th-large mr-2"></i>图片网格切分器
                </button>
            </div>
            
            <!-- 网站图标提取工具 -->
            <div id="faviconTab" class="tab-content active p-6">
                <!-- 主功能区 -->
                <div class="bg-gray-50 rounded-xl p-6 mb-8 tool-card">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="url" id="urlInput" placeholder="输入网站URL (如: https://baidu.com)" 
                               class="flex-grow px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="fetchBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition flex items-center justify-center">
                            <i class="fas fa-search mr-2"></i>提取图标
                        </button>
                    </div>
                    
                    <!-- 高级选项 -->
                    <div class="mt-4">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="advancedToggle" class="mr-2">
                            <label for="advancedToggle" class="text-sm text-gray-600 cursor-pointer">显示高级选项</label>
                        </div>
                        <div id="advancedOptions" class="hidden bg-white p-4 rounded-lg space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">获取方式</label>
                                <select id="methodSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="auto">自动选择最佳方式</option>
                                    <option value="root">根目录favicon.ico</option>
                                    <option value="google">Google Favicon API</option>
                                    <option value="meta">解析HTML meta标签</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">图标尺寸</label>
                                <select id="sizeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="16">16x16 (默认)</option>
                                    <option value="32">32x32</option>
                                    <option value="64">64x64</option>
                                    <option value="128">128x128</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 结果展示区 -->
                <div id="resultSection" class="hidden bg-white rounded-xl shadow-lg p-6 tool-card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-image mr-2 text-indigo-500"></i>提取结果
                        <span id="loadingIndicator" class="ml-auto hidden">
                            <i class="fas fa-spinner loading-spinner text-indigo-500"></i>
                        </span>
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 图标预览 -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-medium text-gray-700 mb-3">图标预览</h3>
                            <div class="flex flex-col items-center">
                                <img id="iconPreview" src="" alt="网站图标预览" class="result-icon w-32 h-32 object-contain mb-3">
                                <div id="iconInfo" class="text-center text-sm text-gray-600">
                                    <p>尺寸: <span id="iconSize">-</span></p>
                                    <p>格式: <span id="iconFormat">-</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 下载选项 -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-medium text-gray-700 mb-3">下载选项</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">下载格式</label>
                                    <select id="downloadFormat" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        <option value="original">原始格式</option>
                                        <option value="png">PNG</option>
                                        <option value="ico">ICO</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">下载尺寸</label>
                                    <select id="downloadSize" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        <option value="original">原始尺寸</option>
                                        <option value="16">16x16</option>
                                        <option value="32">32x32</option>
                                        <option value="64">64x64</option>
                                    </select>
                                </div>
                                <button id="downloadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-md transition">
                                    <i class="fas fa-download mr-2"></i>下载图标
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 技术详情 -->
                    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-2">技术详情</h3>
                        <div id="techDetails" class="text-sm text-gray-600 space-y-2">
                            <p>获取方式: <span id="methodUsed" class="font-medium">-</span></p>
                            <p>原始URL: <span id="originalUrl" class="font-mono text-xs break-all">-</span></p>
                            <p id="fallbackInfo" class="hidden text-yellow-600">
                                <i class="fas fa-exclamation-triangle mr-1"></i>使用了备用获取方式
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 历史记录 -->
                <div id="historySection" class="mt-8 hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-history mr-2 text-indigo-500"></i>历史记录
                    </h2>
                    <div id="historyList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        <!-- 动态生成历史记录 -->
                    </div>
                </div>
            </div>
            
            <!-- 高级图片切分器工具 -->
            <div id="splitterTab" class="tab-content p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 左侧：上传与设置 -->
                    <div class="bg-gray-50 rounded-xl p-6 tool-card">
                        <h2 class="section-title">
                            <i class="fas fa-upload mr-2"></i>上传与设置
                        </h2>
                        
                        <div class="upload-area" id="dropArea">
                            <i class="fas fa-cloud-upload-alt text-3xl text-indigo-500 mb-2"></i>
                            <p>拖放图片到此处或点击上传</p>
                            <p class="text-sm text-indigo-600 mt-1" id="fileInfo">支持 PNG, JPG, JPEG (最大 5MB)</p>
                            <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        </div>
                        
                        <div class="controls space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">切分模式</label>
                                <div class="flex gap-2">
                                    <button id="modeRegular" class="mode-btn flex-1 py-2 rounded-md border border-gray-300 bg-white font-medium active">
                                        规则网格
                                    </button>
                                    <button id="modeCustom" class="mode-btn flex-1 py-2 rounded-md border border-gray-300 bg-white font-medium">
                                        自定义切分
                                    </button>
                                </div>
                            </div>
                            
                            <div id="regularControls">
                                <div class="mb-4">
                                    <label for="rows" class="block text-sm font-medium text-gray-700 mb-1">行数: <span id="rowsValue">1</span></label>
                                    <input type="range" id="rows" min="1" max="10" value="1" class="w-full range-slider">
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>1</span>
                                        <span>10</span>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="cols" class="block text-sm font-medium text-gray-700 mb-1">列数: <span id="colsValue">2</span></label>
                                    <input type="range" id="cols" min="1" max="10" value="2" class="w-full range-slider">
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>1</span>
                                        <span>10</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="gapSize" class="block text-sm font-medium text-gray-700 mb-1">间距大小: <span id="gapValue">1</span>px</label>
                                <input type="range" id="gapSize" min="0" max="10" value="1" class="w-full range-slider">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0</span>
                                    <span>10</span>
                                </div>
                            </div>
                            
                            <div id="customControls" class="hidden space-y-2">
                                <div class="grid grid-cols-3 gap-2">
                                    <button id="addRowBtn" class="py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-sm">
                                        <i class="fas fa-plus mr-1"></i>水平线
                                    </button>
                                    <button id="addColBtn" class="py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-sm">
                                        <i class="fas fa-plus mr-1"></i>垂直线
                                    </button>
                                    <button id="resetLinesBtn" class="py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-sm">
                                        <i class="fas fa-redo mr-1"></i>重置
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500">自定义模式：添加切分线后拖动调整位置</p>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button id="previewSplitBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-md transition" disabled>
                                    <i class="fas fa-eye mr-2"></i>预览切分
                                </button>
                                <button id="resetSplitBtn" class="px-4 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-md transition">
                                    <i class="fas fa-redo mr-2"></i>重置
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：预览与结果 -->
                    <div class="space-y-6">
                        <!-- 图片预览 -->
                        <div class="bg-gray-50 rounded-xl p-6 tool-card">
                            <h2 class="section-title">
                                <i class="fas fa-image mr-2"></i>图片预览
                            </h2>
                            
                            <div class="preview-container" id="previewContainer">
                                <div id="gridInfo" class="absolute top-2 right-2 bg-black bg-opacity-70 text-white px-3 py-1 rounded text-sm z-10 hidden">拖动切分线调整位置</div>
                                <div id="placeholder" class="flex flex-col items-center justify-center w-full h-full text-gray-400">
                                    <i class="fas fa-image text-5xl mb-2"></i>
                                    <p>上传图片后预览将显示在这里</p>
                                </div>
                                <canvas id="previewCanvas"></canvas>
                                <div id="gridOverlay" class="grid-overlay"></div>
                                <div id="imageDimensions" class="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-xs z-10 hidden"></div>
                            </div>
                            
                            <div class="flex gap-3 mt-4">
                                <button id="downloadSplitBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md transition" disabled>
                                    <i class="fas fa-download mr-2"></i>下载所有切分
                                </button>
                                <button id="downloadSplitZipBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md transition" disabled>
                                    <i class="fas fa-file-archive mr-2"></i>打包下载
                                </button>
                            </div>
                        </div>
                        
                        <!-- 切分预览 -->
                        <div class="bg-gray-50 rounded-xl p-6 tool-card">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="section-title">
                                    <i class="fas fa-th mr-2"></i>切分预览
                                </h2>
                                <div class="bg-white px-3 py-1 rounded-full border border-gray-300 text-sm" id="tileCount">0 个切分块</div>
                            </div>
                            
                            <div class="tiles-preview-container">
                                <div class="tiles-preview-content" id="tilesPreview">
                                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                        <i class="fas fa-th text-4xl mb-2"></i>
                                        <p>切分后的图片块将显示在这里</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 图片网格切分器工具 -->
            <div id="gridTab" class="tab-content p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 左侧：上传与预览 -->
                    <div class="bg-gray-50 rounded-xl p-6 tool-card">
                        <h2 class="section-title">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>上传图片
                        </h2>
                        
                        <div class="upload-area" id="uploadAreaGrid">
                            <div class="upload-icon">
                                <i class="fas fa-file-image text-4xl text-indigo-500 mb-2"></i>
                            </div>
                            <p class="text-lg text-gray-700">拖放图片文件到此处，或点击上传</p>
                            <p class="text-sm text-indigo-600 mt-1">支持 JPG, PNG, GIF, WEBP 格式，最大 5MB</p>
                            <input type="file" id="fileInputGrid" class="file-input" accept="image/*" style="display: none;">
                        </div>
                        
                        <div class="mt-6">
                            <h2 class="section-title">
                                <i class="fas fa-eye mr-2"></i>预览
                            </h2>
                            
                            <div id="imagePreviewContainerGrid">
                                <div class="no-image-message text-center py-10" id="noImageMessageGrid">
                                    <i class="fas fa-image text-5xl mb-4 text-gray-300"></i>
                                    <p class="text-gray-500">上传图片后，这里将显示切分结果预览</p>
                                </div>
                                
                                <div class="preview-wrapper mt-4" id="previewWrapperGrid" style="display: none;">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-medium text-gray-700">切分预览</h3>
                                        <div class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium" id="gridSizeDisplayGrid">左右分割 (1×2)</div>
                                    </div>
                                    <div class="relative border border-gray-200 rounded-lg overflow-hidden bg-gray-50" id="gridImageContainer">
                                        <img id="imagePreviewGrid" class="max-w-full h-auto mx-auto" alt="图片预览">
                                        <div id="gridOverlayGrid" class="grid-overlay"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：网格设置与结果 -->
                    <div class="bg-gray-50 rounded-xl p-6 tool-card">
                        <h2 class="section-title">
                            <i class="fas fa-sliders-h mr-2"></i>网格设置
                        </h2>
                        
                        <div class="split-presets">
                            <button class="split-preset-btn split-mode active" data-rows="1" data-cols="2" data-split="true">
                                <i class="fas fa-columns mr-1"></i> 左右分割 (1×2)
                            </button>
                            <button class="split-preset-btn split-mode" data-rows="2" data-cols="1" data-split="true">
                                <i class="fas fa-ellipsis-h mr-1"></i> 上下分割 (2×1)
                            </button>
                            <button class="split-preset-btn split-mode" data-rows="1" data-cols="3" data-split="true">
                                <i class="fas fa-grip-lines mr-1"></i> 三列分割 (1×3)
                            </button>
                            <button class="split-preset-btn split-mode" data-rows="3" data-cols="1" data-split="true">
                                <i class="fas fa-grip-lines-vertical mr-1"></i> 三行分割 (3×1)
                            </button>
                            <button class="split-preset-btn" data-rows="3" data-cols="3">
                                <i class="fas fa-th-large mr-1"></i> 九宫格 (3×3)
                            </button>
                            <button class="split-preset-btn" data-rows="2" data-cols="3">
                                <i class="fas fa-th mr-1"></i> 六宫格 (2×3)
                            </button>
                            <button class="split-preset-btn" data-rows="3" data-cols="2">
                                <i class="fas fa-th mr-1"></i> 六宫格 (3×2)
                            </button>
                            <button class="split-preset-btn" data-rows="4" data-cols="4">
                                <i class="fas fa-border-all mr-1"></i> 16宫格 (4×4)
                            </button>
                        </div>
                        
                        <div class="split-controls">
                            <div class="split-control">
                                <label for="rowsSliderGrid">行数: <span id="rowsValueGrid">1</span></label>
                                <div class="slider-container">
                                    <input type="range" id="rowsSliderGrid" min="1" max="10" value="1" class="range-slider">
                                    <span class="slider-value" id="rowsDisplayGrid">1</span>
                                </div>
                            </div>
                            
                            <div class="split-control">
                                <label for="colsSliderGrid">列数: <span id="colsValueGrid">2</span></label>
                                <div class="slider-container">
                                    <input type="range" id="colsSliderGrid" min="1" max="10" value="2" class="range-slider">
                                    <span class="slider-value" id="colsDisplayGrid">2</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="split-info" id="splitInfoGrid">
                            <i class="fas fa-info-circle mr-2"></i> 当前为分割模式：图片将被分割为独立的左右/上下部分，每个部分可以单独使用。
                        </div>
                        
                        <div class="action-buttons flex gap-3 mt-6">
                            <button id="splitBtnGrid" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-md transition font-medium" disabled>
                                <i class="fas fa-cut mr-2"></i>切分图片
                            </button>
                            <button id="resetBtnGrid" class="px-6 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-md transition font-medium">
                                <i class="fas fa-redo mr-2"></i>重置
                            </button>
                        </div>
                        
                        <!-- 切分结果 -->
                        <div class="mt-8" id="splitResultsGrid" style="display: none;">
                            <h2 class="section-title">
                                <i class="fas fa-th-large mr-2"></i>切分结果
                            </h2>
                            
                            <div class="split-images-container" id="splitImagesContainerGrid"></div>
                            
                            <div class="download-options flex gap-3 mt-6">
                                <button id="downloadAllBtnGrid" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-md transition font-medium">
                                    <i class="fas fa-download mr-2"></i> 下载全部 (ZIP)
                                </button>
                                <button id="downloadGridBtnGrid" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-md transition font-medium">
                                    <i class="fas fa-th-large mr-2"></i> 下载网格图
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <footer class="text-center text-gray-500 text-sm mt-8">
            <p>© 2023 图像处理工具集 | 本工具完全在浏览器中运行，不会上传您的图片到任何服务器</p>
        </footer>
    </div>

    <!-- 引入JSZip和FileSaver用于网格切分器的ZIP下载功能 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // =================== 标签页切换功能 ===================
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                
                // 更新标签按钮状态
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // 显示对应内容
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}Tab`).classList.add('active');
            });
        });
        
        // =================== 网站图标提取功能 ===================
        // 存储历史记录
        let history = JSON.parse(localStorage.getItem('faviconHistory')) || [];
        
        // DOM元素
        const urlInput = document.getElementById('urlInput');
        const fetchBtn = document.getElementById('fetchBtn');
        const resultSection = document.getElementById('resultSection');
        const iconPreview = document.getElementById('iconPreview');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const methodSelect = document.getElementById('methodSelect');
        const advancedToggle = document.getElementById('advancedToggle');
        const advancedOptions = document.getElementById('advancedOptions');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');
        const downloadBtn = document.getElementById('downloadBtn');

        // 初始化事件监听
        function initFaviconEventListeners() {
            // 提取按钮点击事件
            fetchBtn.addEventListener('click', fetchFavicon);
            
            // 高级选项切换
            advancedToggle.addEventListener('change', () => {
                advancedOptions.classList.toggle('hidden', !advancedToggle.checked);
            });
            
            // 回车键触发提取
            urlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') fetchFavicon();
            });
            
            // 下载按钮点击事件
            downloadBtn.addEventListener('click', downloadFavicon);
            
            // 加载历史记录
            renderHistory();
        }
        
        // 获取favicon
        async function fetchFavicon() {
            const url = urlInput.value.trim();
            if (!url) {
                alert('请输入有效的网址');
                return;
            }
            
            try {
                loadingIndicator.classList.remove('hidden');
                resultSection.classList.add('hidden');
                
                // 标准化URL
                let normalizedUrl = url;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    normalizedUrl = `https://${url}`;
                }
                
                const method = methodSelect.value;
                let faviconUrl = '';
                let fallbackUsed = false;
                
                // 根据选择的方法获取图标
                switch(method) {
                    case 'root':
                        faviconUrl = await getRootFavicon(normalizedUrl);
                        break;
                    case 'google':
                        faviconUrl = getGoogleFavicon(normalizedUrl);
                        break;
                    case 'meta':
                        faviconUrl = await getMetaFavicon(normalizedUrl);
                        break;
                    default: // auto
                        faviconUrl = await getRootFavicon(normalizedUrl);
                        if (!await checkImageExists(faviconUrl)) {
                            faviconUrl = await getMetaFavicon(normalizedUrl);
                            if (!await checkImageExists(faviconUrl)) {
                                faviconUrl = getGoogleFavicon(normalizedUrl);
                                fallbackUsed = true;
                            }
                        }
                }
                
                // 显示结果
                if (faviconUrl) {
                    const size = document.getElementById('sizeSelect').value;
                    const sizedUrl = size !== '16' ? `${faviconUrl}?size=${size}` : faviconUrl;
                    
                    iconPreview.src = sizedUrl;
                    iconPreview.onload = () => {
                        updateIconInfo(faviconUrl);
                        document.getElementById('methodUsed').textContent = getMethodName(method);
                        document.getElementById('originalUrl').textContent = faviconUrl;
                        document.getElementById('fallbackInfo').classList.toggle('hidden', !fallbackUsed);
                        
                        // 添加到历史记录
                        addToHistory(normalizedUrl, faviconUrl);
                        
                        loadingIndicator.classList.add('hidden');
                        resultSection.classList.remove('hidden');
                        historySection.classList.remove('hidden');
                    };
                    
                    iconPreview.onerror = () => {
                        showError('无法加载图标图像');
                    };
                } else {
                    showError('未能找到该网站的图标');
                }
            } catch (error) {
                console.error('获取图标失败:', error);
                showError('获取图标时发生错误');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // 获取根目录favicon
        async function getRootFavicon(url) {
            try {
                const urlObj = new URL(url);
                return `${urlObj.protocol}//${urlObj.host}/favicon.ico`;
            } catch {
                return '';
            }
        }
        
        // 使用Google API获取favicon
        function getGoogleFavicon(url) {
            try {
                const urlObj = new URL(url);
                return `https://www.google.com/s2/favicons?domain=${urlObj.host}`;
            } catch {
                return '';
            }
        }
        
        // 解析HTML meta标签获取favicon
        async function getMetaFavicon(url) {
            try {
                // 使用代理解决CORS问题
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                if (data.contents) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data.contents, 'text/html');
                    
                    // 查找icon链接
                    const iconLink = doc.querySelector('link[rel*="icon"]');
                    if (iconLink) {
                        const href = iconLink.getAttribute('href');
                        if (href.startsWith('http')) {
                            return href;
                        } else {
                            const urlObj = new URL(url);
                            return `${urlObj.protocol}//${urlObj.host}${href.startsWith('/') ? '' : '/'}${href}`;
                        }
                    }
                }
                return '';
            } catch {
                return '';
            }
        }
        
        // 检查图片是否存在
        function checkImageExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }
        
        // 更新图标信息
        function updateIconInfo(url) {
            const format = url.split('.').pop().toUpperCase();
            document.getElementById('iconFormat').textContent = format;
            
            // 获取实际尺寸
            const img = new Image();
            img.onload = function() {
                document.getElementById('iconSize').textContent = `${this.width}×${this.height} 像素`;
            };
            img.src = url;
        }
        
        // 下载图标
        function downloadFavicon() {
            const format = document.getElementById('downloadFormat').value;
            const size = document.getElementById('downloadSize').value;
            let downloadUrl = iconPreview.src;
            let filename = 'favicon';
            
            // 处理下载选项
            if (format !== 'original') {
                filename += `.${format}`;
                // 实际项目中这里需要添加格式转换逻辑
            } else {
                const ext = downloadUrl.split('.').pop().split('?')[0];
                filename += `.${ext}`;
            }
            
            // 创建下载链接
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // 添加到历史记录
        function addToHistory(url, faviconUrl) {
            // 检查是否已存在
            const existingIndex = history.findIndex(item => item.url === url);
            if (existingIndex >= 0) {
                history.splice(existingIndex, 1);
            }
            
            // 添加到开头
            history.unshift({
                url,
                faviconUrl,
                date: new Date().toISOString()
            });
            
            // 限制历史记录数量
            if (history.length > 12) {
                history = history.slice(0, 12);
            }
            
            // 保存并重新渲染
            localStorage.setItem('faviconHistory', JSON.stringify(history));
            renderHistory();
        }
        
        // 渲染历史记录
        function renderHistory() {
            if (history.length === 0) return;
            
            historyList.innerHTML = '';
            history.forEach((item, index) => {
                const host = new URL(item.url).host;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow p-3 flex flex-col items-center cursor-pointer hover:bg-indigo-50 transition';
                card.innerHTML = `
                    <img src="${item.faviconUrl}" alt="${host}图标" class="w-10 h-10 mb-2">
                    <p class="text-xs text-center text-gray-700 truncate w-full">${host}</p>
                    <p class="text-xs text-gray-400 mt-1">${new Date(item.date).toLocaleDateString()}</p>
                `;
                card.addEventListener('click', () => {
                    urlInput.value = item.url;
                    fetchFavicon();
                });
                historyList.appendChild(card);
            });
            
            historySection.classList.remove('hidden');
        }
        
        // 显示错误
        function showError(message) {
            alert(message);
            loadingIndicator.classList.add('hidden');
        }
        
        // 获取方法名称
        function getMethodName(method) {
            const methods = {
                'root': '根目录favicon.ico',
                'google': 'Google Favicon API',
                'meta': 'HTML meta标签解析',
                'auto': '自动检测'
            };
            return methods[method] || method;
        }
        
        // =================== 高级图片切分器功能 ===================
        // DOM元素
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('dropArea');
        const previewCanvas = document.getElementById('previewCanvas');
        const ctx = previewCanvas.getContext('2d');
        const placeholder = document.getElementById('placeholder');
        const gridOverlay = document.getElementById('gridOverlay');
        const gridInfo = document.getElementById('gridInfo');
        const previewContainer = document.getElementById('previewContainer');
        const imageDimensions = document.getElementById('imageDimensions');
        const rowsInput = document.getElementById('rows');
        const colsInput = document.getElementById('cols');
        const gapInput = document.getElementById('gapSize');
        const rowsValue = document.getElementById('rowsValue');
        const colsValue = document.getElementById('colsValue');
        const gapValue = document.getElementById('gapValue');
        const previewSplitBtn = document.getElementById('previewSplitBtn');
        const resetSplitBtn = document.getElementById('resetSplitBtn');
        const tilesPreview = document.getElementById('tilesPreview');
        const tileCount = document.getElementById('tileCount');
        const modeRegular = document.getElementById('modeRegular');
        const modeCustom = document.getElementById('modeCustom');
        const regularControls = document.getElementById('regularControls');
        const customControls = document.getElementById('customControls');
        const addRowBtn = document.getElementById('addRowBtn');
        const addColBtn = document.getElementById('addColBtn');
        const resetLinesBtn = document.getElementById('resetLinesBtn');
        const fileInfo = document.getElementById('fileInfo');
        const downloadSplitBtn = document.getElementById('downloadSplitBtn');
        const downloadSplitZipBtn = document.getElementById('downloadSplitZipBtn');
        
        // 全局变量
        let originalImage = null;
        let imageUrl = null;
        let tiles = [];
        let mode = 'regular'; // 'regular' 或 'custom'
        let customHorizontalLines = []; // 自定义水平线位置 (百分比)
        let customVerticalLines = [];   // 自定义垂直线位置 (百分比)
        let isDragging = false;
        let draggedLine = null;
        let draggedLineType = null; // 'horizontal' 或 'vertical'
        let draggedLineIndex = null;
        let canvasDisplayWidth = 0;
        let canvasDisplayHeight = 0;
        
        // 事件监听器
        function initSplitterEventListeners() {
            dropArea.addEventListener('click', () => fileInput.click());
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#2980b9';
                dropArea.style.backgroundColor = '#f0f8ff';
            });
            dropArea.addEventListener('dragleave', () => {
                dropArea.style.borderColor = '#3498db';
                dropArea.style.backgroundColor = '';
            });
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#3498db';
                dropArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            rowsInput.addEventListener('input', () => {
                rowsValue.textContent = rowsInput.value;
                if (mode === 'regular') previewGrid();
            });
            
            colsInput.addEventListener('input', () => {
                colsValue.textContent = colsInput.value;
                if (mode === 'regular') previewGrid();
            });
            
            gapInput.addEventListener('input', () => {
                gapValue.textContent = gapInput.value;
                if (originalImage) previewGrid();
            });
            
            modeRegular.addEventListener('click', () => switchMode('regular'));
            modeCustom.addEventListener('click', () => switchMode('custom'));
            previewSplitBtn.addEventListener('click', previewGrid);
            resetSplitBtn.addEventListener('click', resetAll);
            downloadSplitBtn.addEventListener('click', downloadAllTiles);
            downloadSplitZipBtn.addEventListener('click', downloadAsZip);
            addRowBtn.addEventListener('click', addHorizontalLine);
            addColBtn.addEventListener('click', addVerticalLine);
            resetLinesBtn.addEventListener('click', resetCustomLines);
        }
        
        // 模式切换
        function switchMode(newMode) {
            mode = newMode;
            
            if (mode === 'regular') {
                modeRegular.classList.add('active');
                modeRegular.classList.remove('bg-white');
                modeRegular.classList.add('bg-indigo-100', 'border-indigo-300');
                modeCustom.classList.remove('active');
                modeCustom.classList.add('bg-white');
                modeCustom.classList.remove('bg-indigo-100', 'border-indigo-300');
                regularControls.classList.remove('hidden');
                customControls.classList.add('hidden');
                gridInfo.style.display = 'none';
            } else {
                modeRegular.classList.remove('active');
                modeRegular.classList.add('bg-white');
                modeRegular.classList.remove('bg-indigo-100', 'border-indigo-300');
                modeCustom.classList.add('active');
                modeCustom.classList.remove('bg-white');
                modeCustom.classList.add('bg-indigo-100', 'border-indigo-300');
                regularControls.classList.add('hidden');
                customControls.classList.remove('hidden');
                gridInfo.style.display = 'block';
            }
            
            if (originalImage) {
                previewGrid();
            }
        }
        
        // 处理图片上传
        function handleImageUpload(file) {
            // 检查文件类型和大小
            if (!file.type.match('image.*')) {
                alert('请上传图片文件（PNG、JPG、JPEG）');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('图片大小不能超过5MB');
                return;
            }
            
            // 释放之前的URL
            if (imageUrl) {
                URL.revokeObjectURL(imageUrl);
            }
            
            // 创建新的URL
            imageUrl = URL.createObjectURL(file);
            
            // 加载图片
            originalImage = new Image();
            originalImage.onload = () => {
                // 更新UI
                placeholder.style.display = 'none';
                previewCanvas.style.display = 'block';
                imageDimensions.style.display = 'block';
                
                // 计算显示尺寸，保持宽高比，左对齐
                const containerWidth = previewContainer.clientWidth;
                const containerHeight = previewContainer.clientHeight;
                
                let width = originalImage.width;
                let height = originalImage.height;
                
                // 保持宽高比
                const widthRatio = containerWidth / width;
                const heightRatio = containerHeight / height;
                const ratio = Math.min(widthRatio, heightRatio);
                
                width = width * ratio;
                height = height * ratio;
                
                canvasDisplayWidth = width;
                canvasDisplayHeight = height;
                
                // 设置canvas显示尺寸
                previewCanvas.style.width = `${width}px`;
                previewCanvas.style.height = `${height}px`;
                previewCanvas.style.left = '0';
                previewCanvas.style.top = '0';
                previewCanvas.style.position = 'absolute';
                
                // 设置canvas实际分辨率（保持高质量）
                const scale = window.devicePixelRatio || 1;
                previewCanvas.width = originalImage.width * scale;
                previewCanvas.height = originalImage.height * scale;
                ctx.scale(scale, scale);
                
                // 清除画布并绘制图片
                ctx.clearRect(0, 0, originalImage.width, originalImage.height);
                ctx.drawImage(originalImage, 0, 0, originalImage.width, originalImage.height);
                
                // 更新图片尺寸显示
                imageDimensions.textContent = `${originalImage.width}×${originalImage.height}像素`;
                
                // 启用预览按钮
                previewSplitBtn.disabled = false;
                
                // 更新上传区域显示文件名
                fileInfo.textContent = `已选择: ${file.name} (${originalImage.width}×${originalImage.height}像素)`;
                
                // 重置自定义切分线
                resetCustomLines();
                
                // 生成预览网格
                previewGrid();
            };
            
            originalImage.onerror = () => {
                alert('图片加载失败，请重试');
            };
            
            originalImage.src = imageUrl;
        }
        
        // 预览网格切分
        function previewGrid() {
            if (!originalImage) return;
            
            const gap = parseInt(gapInput.value);
            
            // 清除之前的网格线
            gridOverlay.innerHTML = '';
            
            // 获取显示尺寸
            const canvasWidth = canvasDisplayWidth;
            const canvasHeight = canvasDisplayHeight;
            
            if (mode === 'regular') {
                // 规则网格模式
                const rows = parseInt(rowsInput.value);
                const cols = parseInt(colsInput.value);
                
                const cellWidth = canvasWidth / cols;
                const cellHeight = canvasHeight / rows;
                
                // 绘制垂直网格线
                for (let i = 1; i < cols; i++) {
                    const linePos = i * cellWidth;
                    createGridLine(
                        linePos - (gap/2), 
                        0, 
                        gap, 
                        canvasHeight, 
                        false, 
                        'vertical'
                    );
                }
                
                // 绘制水平网格线
                for (let i = 1; i < rows; i++) {
                    const linePos = i * cellHeight;
                    createGridLine(
                        0, 
                        linePos - (gap/2), 
                        canvasWidth, 
                        gap, 
                        false, 
                        'horizontal'
                    );
                }
                
                // 生成切分预览
                generateTilesPreviewRegular(rows, cols, gap);
            } else {
                // 自定义切分模式
                // 排序切分线
                customHorizontalLines.sort((a, b) => a - b);
                customVerticalLines.sort((a, b) => a - b);
                
                // 绘制自定义水平线
                customHorizontalLines.forEach((linePos, index) => {
                    const yPos = (linePos * canvasHeight) - (gap/2);
                    createGridLine(
                        0, 
                        yPos, 
                        canvasWidth, 
                        gap, 
                        true, 
                        'horizontal',
                        index
                    );
                });
                
                // 绘制自定义垂直线
                customVerticalLines.forEach((linePos, index) => {
                    const xPos = (linePos * canvasWidth) - (gap/2);
                    createGridLine(
                        xPos, 
                        0, 
                        gap, 
                        canvasHeight, 
                        true, 
                        'vertical',
                        index
                    );
                });
                
                // 生成切分预览
                generateTilesPreviewCustom(gap);
            }
            
            // 启用下载按钮
            downloadSplitBtn.disabled = false;
            downloadSplitZipBtn.disabled = false;
        }
        
        // 创建网格线
        function createGridLine(left, top, width, height, draggable, type, index = null) {
            const line = document.createElement('div');
            line.className = `grid-line ${type}`;
            line.style.left = `${left}px`;
            line.style.top = `${top}px`;
            line.style.width = `${width}px`;
            line.style.height = `${height}px`;
            
            // 确保线居中显示
            if (type === 'vertical' && width > 0) {
                line.style.transform = 'translateX(-50%)';
                line.style.left = `${left + width/2}px`;
            }
            
            if (type === 'horizontal' && height > 0) {
                line.style.transform = 'translateY(-50%)';
                line.style.top = `${top + height/2}px`;
            }
            
            if (draggable) {
                line.classList.add('draggable');
                line.dataset.type = type;
                line.dataset.index = index;
                
                // 添加拖动事件
                line.addEventListener('mousedown', startDrag);
                line.addEventListener('touchstart', startDragTouch);
            }
            
            gridOverlay.appendChild(line);
        }
        
        // 开始拖动（鼠标）
        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            draggedLine = this;
            draggedLineType = this.dataset.type;
            draggedLineIndex = parseInt(this.dataset.index);
            
            // 添加拖动类
            this.classList.add('dragging');
            
            // 添加全局事件监听器
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            // 显示提示信息
            gridInfo.textContent = `拖动${draggedLineType === 'horizontal' ? '水平' : '垂直'}切分线调整位置`;
            gridInfo.style.display = 'block';
        }
        
        // 开始拖动（触摸）
        function startDragTouch(e) {
            e.preventDefault();
            isDragging = true;
            draggedLine = this;
            draggedLineType = this.dataset.type;
            draggedLineIndex = parseInt(this.dataset.index);
            
            // 添加拖动类
            this.classList.add('dragging');
            
            // 添加全局事件监听器
            document.addEventListener('touchmove', dragTouch);
            document.addEventListener('touchend', stopDrag);
            
            // 显示提示信息
            gridInfo.textContent = `拖动${draggedLineType === 'horizontal' ? '水平' : '垂直'}切分线调整位置`;
            gridInfo.style.display = 'block';
        }
        
        // 拖动（鼠标）
        function drag(e) {
            if (!isDragging) return;
            
            const rect = previewContainer.getBoundingClientRect();
            const canvasWidth = canvasDisplayWidth;
            const canvasHeight = canvasDisplayHeight;
            
            let newPos;
            if (draggedLineType === 'horizontal') {
                newPos = (e.clientY - rect.top) / canvasHeight;
                // 限制位置在边界内
                newPos = Math.max(0.05, Math.min(0.95, newPos));
                customHorizontalLines[draggedLineIndex] = newPos;
                
                // 更新线位置
                const gap = parseInt(gapInput.value);
                draggedLine.style.top = `${(newPos * canvasHeight) - (gap/2)}px`;
                
                // 保持居中
                draggedLine.style.transform = 'translateY(-50%)';
            } else {
                newPos = (e.clientX - rect.left) / canvasWidth;
                // 限制位置在边界内
                newPos = Math.max(0.05, Math.min(0.95, newPos));
                customVerticalLines[draggedLineIndex] = newPos;
                
                // 更新线位置
                const gap = parseInt(gapInput.value);
                draggedLine.style.left = `${(newPos * canvasWidth) - (gap/2)}px`;
                
                // 保持居中
                draggedLine.style.transform = 'translateX(-50%)';
            }
            
            // 重新生成切分预览
            generateTilesPreviewCustom(parseInt(gapInput.value));
        }
        
        // 拖动（触摸）
        function dragTouch(e) {
            if (!isDragging || !e.touches.length) return;
            
            const rect = previewContainer.getBoundingClientRect();
            const canvasWidth = canvasDisplayWidth;
            const canvasHeight = canvasDisplayHeight;
            const touch = e.touches[0];
            
            let newPos;
            if (draggedLineType === 'horizontal') {
                newPos = (touch.clientY - rect.top) / canvasHeight;
                // 限制位置在边界内
                newPos = Math.max(0.05, Math.min(0.95, newPos));
                customHorizontalLines[draggedLineIndex] = newPos;
                
                // 更新线位置
                const gap = parseInt(gapInput.value);
                draggedLine.style.top = `${(newPos * canvasHeight) - (gap/2)}px`;
                
                // 保持居中
                draggedLine.style.transform = 'translateY(-50%)';
            } else {
                newPos = (touch.clientX - rect.left) / canvasWidth;
                // 限制位置在边界内
                newPos = Math.max(0.05, Math.min(0.95, newPos));
                customVerticalLines[draggedLineIndex] = newPos;
                
                // 更新线位置
                const gap = parseInt(gapInput.value);
                draggedLine.style.left = `${(newPos * canvasWidth) - (gap/2)}px`;
                
                // 保持居中
                draggedLine.style.transform = 'translateX(-50%)';
            }
            
            // 重新生成切分预览
            generateTilesPreviewCustom(parseInt(gapInput.value));
        }
        
        // 停止拖动
        function stopDrag() {
            if (!isDragging) return;
            
            isDragging = false;
            if (draggedLine) {
                draggedLine.classList.remove('dragging');
                draggedLine = null;
            }
            
            // 移除全局事件监听器
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', dragTouch);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchend', stopDrag);
            
            // 隐藏提示信息
            setTimeout(() => {
                gridInfo.style.display = 'none';
            }, 1500);
        }
        
        // 添加水平线
        function addHorizontalLine() {
            if (!originalImage) return;
            
            // 添加一条在中间位置的水平线
            customHorizontalLines.push(0.5);
            
            // 重新绘制网格
            previewGrid();
        }
        
        // 添加垂直线
        function addVerticalLine() {
            if (!originalImage) return;
            
            // 添加一条在中间位置的垂直线
            customVerticalLines.push(0.5);
            
            // 重新绘制网格
            previewGrid();
        }
        
        // 重置自定义切分线
        function resetCustomLines() {
            customHorizontalLines = [];
            customVerticalLines = [];
            
            if (originalImage) {
                previewGrid();
            }
        }
        
        // 生成切分预览（规则网格）
        function generateTilesPreviewRegular(rows, cols, gap) {
            tiles = [];
            tilesPreview.innerHTML = '';
            
            // 创建离屏canvas用于切分
            const offscreenCanvas = document.createElement('canvas');
            const offscreenCtx = offscreenCanvas.getContext('2d');
            
            // 设置离屏canvas为原始图片尺寸
            offscreenCanvas.width = originalImage.width;
            offscreenCanvas.height = originalImage.height;
            offscreenCtx.drawImage(originalImage, 0, 0);
            
            // 计算每个切分块的尺寸
            const originalCellWidth = originalImage.width / cols;
            const originalCellHeight = originalImage.height / rows;
            
            // 考虑间距调整
            const gapWidth = gap * (originalImage.width / canvasDisplayWidth);
            const gapHeight = gap * (originalImage.height / canvasDisplayHeight);
            
            // 生成每个切分块
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    // 计算切分区域（考虑间距）
                    const sx = col * originalCellWidth + (col > 0 ? gapWidth/2 : 0);
                    const sy = row * originalCellHeight + (row > 0 ? gapHeight/2 : 0);
                    const sw = originalCellWidth - (col > 0 ? gapWidth/2 : 0) - (col < cols-1 ? gapWidth/2 : 0);
                    const sh = originalCellHeight - (row > 0 ? gapHeight/2 : 0) - (row < rows-1 ? gapHeight/2 : 0);
                    
                    // 确保尺寸为正
                    if (sw <= 0 || sh <= 0) continue;
                    
                    // 创建canvas用于存储切分块
                    const tileCanvas = document.createElement('canvas');
                    tileCanvas.width = sw;
                    tileCanvas.height = sh;
                    const tileCtx = tileCanvas.getContext('2d');
                    
                    // 绘制切分块
                    tileCtx.drawImage(
                        offscreenCanvas,
                        sx, sy, sw, sh,
                        0, 0, sw, sh
                    );
                    
                    // 存储切分块数据
                    tiles.push({
                        canvas: tileCanvas,
                        row: row,
                        col: col,
                        width: sw,
                        height: sh
                    });
                    
                    // 创建预览缩略图
                    const tileDataUrl = tileCanvas.toDataURL('image/png');
                    createTilePreview(tileDataUrl, row, col, sw, sh);
                }
            }
            
            // 更新切分块计数
            tileCount.textContent = `${tiles.length} 个切分块`;
        }
        
        // 生成切分预览（自定义网格）
        function generateTilesPreviewCustom(gap) {
            tiles = [];
            tilesPreview.innerHTML = '';
            
            // 如果没有自定义线，则整个图片为一个块
            const horizontalLines = customHorizontalLines.slice().sort((a, b) => a - b);
            const verticalLines = customVerticalLines.slice().sort((a, b) => a - b);
            
            // 添加边界线（0和1）
            const allHorizontalLines = [0, ...horizontalLines, 1];
            const allVerticalLines = [0, ...verticalLines, 1];
            
            // 创建离屏canvas用于切分
            const offscreenCanvas = document.createElement('canvas');
            const offscreenCtx = offscreenCanvas.getContext('2d');
            
            // 设置离屏canvas为原始图片尺寸
            offscreenCanvas.width = originalImage.width;
            offscreenCanvas.height = originalImage.height;
            offscreenCtx.drawImage(originalImage, 0, 0);
            
            // 考虑间距调整
            const gapWidth = gap * (originalImage.width / canvasDisplayWidth);
            const gapHeight = gap * (originalImage.height / canvasDisplayHeight);
            
            // 生成每个切分块
            for (let row = 0; row < allHorizontalLines.length - 1; row++) {
                for (let col = 0; col < allVerticalLines.length - 1; col++) {
                    // 计算切分区域（百分比）
                    const topPercent = allHorizontalLines[row];
                    const bottomPercent = allHorizontalLines[row + 1];
                    const leftPercent = allVerticalLines[col];
                    const rightPercent = allVerticalLines[col + 1];
                    
                    // 转换为实际像素坐标（考虑间距）
                    const sx = leftPercent * originalImage.width + (col > 0 ? gapWidth/2 : 0);
                    const sy = topPercent * originalImage.height + (row > 0 ? gapHeight/2 : 0);
                    const sw = (rightPercent - leftPercent) * originalImage.width - 
                              (col > 0 ? gapWidth/2 : 0) - 
                              (col < allVerticalLines.length - 2 ? gapWidth/2 : 0);
                    const sh = (bottomPercent - topPercent) * originalImage.height - 
                              (row > 0 ? gapHeight/2 : 0) - 
                              (row < allHorizontalLines.length - 2 ? gapHeight/2 : 0);
                    
                    // 确保尺寸为正
                    if (sw <= 0 || sh <= 0) continue;
                    
                    // 创建canvas用于存储切分块
                    const tileCanvas = document.createElement('canvas');
                    tileCanvas.width = sw;
                    tileCanvas.height = sh;
                    const tileCtx = tileCanvas.getContext('2d');
                    
                    // 绘制切分块
                    tileCtx.drawImage(
                        offscreenCanvas,
                        sx, sy, sw, sh,
                        0, 0, sw, sh
                    );
                    
                    // 存储切分块数据
                    tiles.push({
                        canvas: tileCanvas,
                        row: row,
                        col: col,
                        width: sw,
                        height: sh
                    });
                    
                    // 创建预览缩略图
                    const tileDataUrl = tileCanvas.toDataURL('image/png');
                    createTilePreview(tileDataUrl, row, col, sw, sh);
                }
            }
            
            // 更新切分块计数
            tileCount.textContent = `${tiles.length} 个切分块`;
        }
        
        // 创建切分预览图
        function createTilePreview(dataUrl, row, col, width, height) {
            const tileContainer = document.createElement('div');
            tileContainer.className = 'tile-item';
            
            const img = document.createElement('img');
            img.className = 'tile';
            img.src = dataUrl;
            img.title = `块 ${row+1}-${col+1} (${Math.round(width)}×${Math.round(height)}像素)`;
            img.alt = `切分块 ${row+1}-${col+1}`;
            
            const info = document.createElement('div');
            info.className = 'tile-info';
            info.textContent = `块 ${row+1}-${col+1} (${Math.round(width)}×${Math.round(height)})`;
            
            tileContainer.appendChild(img);
            tileContainer.appendChild(info);
            tilesPreview.appendChild(tileContainer);
        }
        
        // 下载所有切分块
        function downloadAllTiles() {
            if (tiles.length === 0) return;
            
            tiles.forEach((tile, index) => {
                const link = document.createElement('a');
                link.download = `image_tile_${tile.row+1}_${tile.col+1}.png`;
                link.href = tile.canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        // 打包下载为ZIP
        function downloadAsZip() {
            if (tiles.length === 0) return;
            
            // 由于浏览器限制，这里我们使用简单的方法：创建一个包含所有图片链接的HTML文件
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>切分图片</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .tiles-container { display: flex; flex-wrap: wrap; gap: 10px; }
                        .tile { border: 1px solid #ddd; padding: 5px; }
                        img { max-width: 200px; max-height: 200px; }
                    </style>
                </head>
                <body>
                    <h1>图片切分结果</h1>
                    <p>共 ${tiles.length} 个切分块</p>
                    <div class="tiles-container">
            `;
            
            tiles.forEach((tile, index) => {
                const dataUrl = tile.canvas.toDataURL('image/png');
                htmlContent += `
                    <div class="tile">
                        <p>行 ${tile.row+1}, 列 ${tile.col+1} (${Math.round(tile.width)}×${Math.round(tile.height)}像素)</p>
                        <img src="${dataUrl}" alt="切分块 ${index+1}">
                    </div>
                `;
            });
            
            htmlContent += `
                    </div>
                </body>
                </html>
            `;
            
            // 创建下载链接
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'split_images.html';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('已创建包含所有切分图片的HTML文件。在实际应用中，可以集成JSZip库来创建真正的ZIP文件。');
        }
        
        // 重置所有
        function resetAll() {
            // 清除图片
            if (imageUrl) {
                URL.revokeObjectURL(imageUrl);
                imageUrl = null;
            }
            
            originalImage = null;
            tiles = [];
            
            // 重置UI
            placeholder.style.display = 'flex';
            previewCanvas.style.display = 'none';
            imageDimensions.style.display = 'none';
            gridOverlay.innerHTML = '';
            gridInfo.style.display = 'none';
            tileCount.textContent = '0 个切分块';
            tilesPreview.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-400">
                    <i class="fas fa-th text-4xl mb-2"></i>
                    <p>切分后的图片块将显示在这里</p>
                </div>
            `;
            
            // 重置控件
            rowsInput.value = 3;
            colsInput.value = 3;
            gapInput.value = 2;
            rowsValue.textContent = '3';
            colsValue.textContent = '3';
            gapValue.textContent = '2';
            
            // 重置自定义切分线
            resetCustomLines();
            
            // 切换到规则网格模式
            switchMode('regular');
            
            // 禁用按钮
            previewSplitBtn.disabled = true;
            downloadSplitBtn.disabled = true;
            downloadSplitZipBtn.disabled = true;
            
            // 重置上传区域
            fileInfo.textContent = '支持 PNG, JPG, JPEG (最大 5MB)';
            fileInput.value = '';
        }
        
        // =================== 图片网格切分器功能 ===================
        // DOM元素
        const uploadAreaGrid = document.getElementById('uploadAreaGrid');
        const fileInputGrid = document.getElementById('fileInputGrid');
        const imagePreviewGrid = document.getElementById('imagePreviewGrid');
        const previewWrapperGrid = document.getElementById('previewWrapperGrid');
        const noImageMessageGrid = document.getElementById('noImageMessageGrid');
        const gridOverlayGrid = document.getElementById('gridOverlayGrid');
        const splitImagesContainerGrid = document.getElementById('splitImagesContainerGrid');
        const splitBtnGrid = document.getElementById('splitBtnGrid');
        const resetBtnGrid = document.getElementById('resetBtnGrid');
        const downloadAllBtnGrid = document.getElementById('downloadAllBtnGrid');
        const downloadGridBtnGrid = document.getElementById('downloadGridBtnGrid');
        const rowsSliderGrid = document.getElementById('rowsSliderGrid');
        const colsSliderGrid = document.getElementById('colsSliderGrid');
        const rowsDisplayGrid = document.getElementById('rowsDisplayGrid');
        const colsDisplayGrid = document.getElementById('colsDisplayGrid');
        const rowsValueGrid = document.getElementById('rowsValueGrid');
        const colsValueGrid = document.getElementById('colsValueGrid');
        const gridSizeDisplayGrid = document.getElementById('gridSizeDisplayGrid');
        const splitPresetBtns = document.querySelectorAll('.split-preset-btn');
        const splitInfoGrid = document.getElementById('splitInfoGrid');
        const splitResultsGrid = document.getElementById('splitResultsGrid');
        
        // 全局变量
        let originalImageGrid = null;
        let splitImagesGrid = [];
        let rowsGrid = 1;
        let colsGrid = 2;
        let currentImageNameGrid = '';
        let isSplitModeGrid = true;
        
        // 事件监听器
        function initGridSplitterEventListeners() {
            uploadAreaGrid.addEventListener('click', () => fileInputGrid.click());
            uploadAreaGrid.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadAreaGrid.style.borderColor = '#2980b9';
                uploadAreaGrid.style.backgroundColor = '#f0f8ff';
            });
            uploadAreaGrid.addEventListener('dragleave', () => {
                uploadAreaGrid.style.borderColor = '#3498db';
                uploadAreaGrid.style.backgroundColor = '';
            });
            uploadAreaGrid.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadAreaGrid.style.borderColor = '#3498db';
                uploadAreaGrid.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleImageUploadGrid(e.dataTransfer.files[0]);
                }
            });
            
            fileInputGrid.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleImageUploadGrid(e.target.files[0]);
                }
            });
            
            rowsSliderGrid.addEventListener('input', () => {
                rowsGrid = parseInt(rowsSliderGrid.value);
                rowsDisplayGrid.textContent = rowsGrid;
                rowsValueGrid.textContent = rowsGrid;
                updateGridSizeDisplayGrid();
                updatePresetButtonsGrid();
                updateSplitInfoGrid();
                if (originalImageGrid) drawGridOverlayGrid();
            });
            
            colsSliderGrid.addEventListener('input', () => {
                colsGrid = parseInt(colsSliderGrid.value);
                colsDisplayGrid.textContent = colsGrid;
                colsValueGrid.textContent = colsGrid;
                updateGridSizeDisplayGrid();
                updatePresetButtonsGrid();
                updateSplitInfoGrid();
                if (originalImageGrid) drawGridOverlayGrid();
            });
            
            splitPresetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const newRows = parseInt(btn.dataset.rows);
                    const newCols = parseInt(btn.dataset.cols);
                    const isSplit = btn.dataset.split === "true";
                    
                    rowsGrid = newRows;
                    colsGrid = newCols;
                    isSplitModeGrid = isSplit;
                    
                    rowsSliderGrid.value = rowsGrid;
                    colsSliderGrid.value = colsGrid;
                    rowsDisplayGrid.textContent = rowsGrid;
                    colsDisplayGrid.textContent = colsGrid;
                    rowsValueGrid.textContent = rowsGrid;
                    colsValueGrid.textContent = colsGrid;
                    
                    updateGridSizeDisplayGrid();
                    updatePresetButtonsGrid();
                    updateSplitInfoGrid();
                    
                    // 如果已有图片，重新绘制网格
                    if (originalImageGrid) {
                        drawGridOverlayGrid();
                    }
                });
            });
            
            splitBtnGrid.addEventListener('click', splitImageGrid);
            resetBtnGrid.addEventListener('click', resetAppGrid);
            downloadAllBtnGrid.addEventListener('click', downloadAllImagesGrid);
            downloadGridBtnGrid.addEventListener('click', downloadGridImageGrid);
        }
        
        // 处理图片上传
        function handleImageUploadGrid(file) {
            // 检查文件类型
            if (!file.type.match('image.*')) {
                alert('请上传图片文件 (JPG, PNG, GIF 等格式)');
                return;
            }
            
            // 检查文件大小 (限制为5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('图片大小不能超过5MB');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                originalImageGrid = new Image();
                originalImageGrid.onload = () => {
                    // 显示图片预览
                    imagePreviewGrid.src = e.target.result;
                    previewWrapperGrid.style.display = 'block';
                    noImageMessageGrid.style.display = 'none';
                    
                    // 保存图片名称
                    currentImageNameGrid = file.name.replace(/\.[^/.]+$/, "");
                    
                    // 启用切分按钮
                    splitBtnGrid.disabled = false;
                    
                    // 绘制网格叠加层
                    drawGridOverlayGrid();
                    
                    // 隐藏之前的切分结果
                    splitResultsGrid.style.display = 'none';
                    splitImagesContainerGrid.innerHTML = '';
                };
                originalImageGrid.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        // 绘制网格叠加层
        function drawGridOverlayGrid() {
            if (!originalImageGrid) return;
            
            // 计算预览图片的显示尺寸
            const maxWidth = 500;
            const maxHeight = 400;
            
            let displayWidth = originalImageGrid.width;
            let displayHeight = originalImageGrid.height;
            
            // 按比例缩放以适合预览区域
            if (displayWidth > maxWidth || displayHeight > maxHeight) {
                const ratio = Math.min(maxWidth / displayWidth, maxHeight / displayHeight);
                displayWidth *= ratio;
                displayHeight *= ratio;
            }
            
            // 设置预览图片尺寸
            imagePreviewGrid.style.width = `${displayWidth}px`;
            imagePreviewGrid.style.height = `${displayHeight}px`;
            
            // 清空之前的网格
            gridOverlayGrid.innerHTML = '';
            gridOverlayGrid.style.width = `${displayWidth}px`;
            gridOverlayGrid.style.height = `${displayHeight}px`;
            
            // 计算每个网格单元的尺寸
            const cellWidth = displayWidth / colsGrid;
            const cellHeight = displayHeight / rowsGrid;
            
            // 创建网格单元
            for (let r = 0; r < rowsGrid; r++) {
                for (let c = 0; c < colsGrid; c++) {
                    const cell = document.createElement('div');
                    cell.className = isSplitModeGrid ? 'grid-cell split-cell' : 'grid-cell';
                    cell.style.width = `${cellWidth}px`;
                    cell.style.height = `${cellHeight}px`;
                    cell.style.top = `${r * cellHeight}px`;
                    cell.style.left = `${c * cellWidth}px`;
                    
                    // 添加网格编号
                    const cellNumber = document.createElement('div');
                    cellNumber.style.position = 'absolute';
                    cellNumber.style.top = '5px';
                    cellNumber.style.right = '5px';
                    cellNumber.style.backgroundColor = isSplitModeGrid 
                        ? 'rgba(46, 204, 113, 0.8)' 
                        : 'rgba(52, 152, 219, 0.8)';
                    cellNumber.style.color = 'white';
                    cellNumber.style.width = '22px';
                    cellNumber.style.height = '22px';
                    cellNumber.style.borderRadius = '50%';
                    cellNumber.style.display = 'flex';
                    cellNumber.style.alignItems = 'center';
                    cellNumber.style.justifyContent = 'center';
                    cellNumber.style.fontSize = '12px';
                    cellNumber.style.fontWeight = 'bold';
                    cellNumber.textContent = (r * colsGrid + c + 1);
                    
                    cell.appendChild(cellNumber);
                    gridOverlayGrid.appendChild(cell);
                }
            }
        }
        
        // 切分图片
        function splitImageGrid() {
            if (!originalImageGrid) {
                alert('请先上传图片');
                return;
            }
            
            splitImagesGrid = [];
            splitImagesContainerGrid.innerHTML = '';
            
            // 创建Canvas用于切分
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 计算每个切片的尺寸
            const sliceWidth = originalImageGrid.width / colsGrid;
            const sliceHeight = originalImageGrid.height / rowsGrid;
            
            // 为分割模式生成描述文本
            let splitDescription = '';
            if (isSplitModeGrid) {
                if (rowsGrid === 1 && colsGrid === 2) {
                    splitDescription = '左右分割';
                } else if (rowsGrid === 2 && colsGrid === 1) {
                    splitDescription = '上下分割';
                } else if (rowsGrid === 1 && colsGrid === 3) {
                    splitDescription = '三列分割';
                } else if (rowsGrid === 3 && colsGrid === 1) {
                    splitDescription = '三行分割';
                } else {
                    splitDescription = `${rowsGrid}行${colsGrid}列分割`;
                }
            }
            
            // 切分图片
            for (let r = 0; r < rowsGrid; r++) {
                for (let c = 0; c < colsGrid; c++) {
                    // 设置Canvas尺寸
                    canvas.width = sliceWidth;
                    canvas.height = sliceHeight;
                    
                    // 绘制切片
                    ctx.drawImage(
                        originalImageGrid,
                        c * sliceWidth, r * sliceHeight, sliceWidth, sliceHeight,
                        0, 0, sliceWidth, sliceHeight
                    );
                    
                    // 获取图片数据URL
                    const imageDataURL = canvas.toDataURL('image/png');
                    
                    // 保存切片数据
                    splitImagesGrid.push({
                        row: r,
                        col: c,
                        index: r * colsGrid + c,
                        dataURL: imageDataURL
                    });
                    
                    // 创建预览元素
                    const sliceContainer = document.createElement('div');
                    sliceContainer.className = 'split-image';
                    sliceContainer.style.width = `${Math.min(150, sliceWidth)}px`;
                    sliceContainer.title = `点击下载此切片`;
                    
                    const img = document.createElement('img');
                    img.src = imageDataURL;
                    img.alt = `切片 ${r * colsGrid + c + 1}`;
                    
                    const label = document.createElement('div');
                    label.style.textAlign = 'center';
                    label.style.padding = '8px 5px';
                    label.style.fontSize = '14px';
                    label.style.fontWeight = '600';
                    label.style.color = isSplitModeGrid ? '#27ae60' : '#2c3e50';
                    label.style.backgroundColor = isSplitModeGrid ? '#f0f9f4' : '#f8f9fa';
                    label.textContent = isSplitModeGrid 
                        ? `${splitDescription} ${r * colsGrid + c + 1}` 
                        : `切片 ${r * colsGrid + c + 1}`;
                    
                    sliceContainer.appendChild(img);
                    sliceContainer.appendChild(label);
                    
                    // 添加点击下载单个切片的功能
                    sliceContainer.addEventListener('click', () => {
                        downloadSingleImageGrid(r * colsGrid + c);
                    });
                    
                    splitImagesContainerGrid.appendChild(sliceContainer);
                }
            }
            
            // 显示切分结果
            splitResultsGrid.style.display = 'block';
            
            // 滚动到切分结果区域
            splitResultsGrid.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // 下载单个切片
        function downloadSingleImageGrid(index) {
            if (!splitImagesGrid[index]) return;
            
            const splitText = isSplitModeGrid ? '分割' : '切片';
            const link = document.createElement('a');
            link.href = splitImagesGrid[index].dataURL;
            link.download = `${currentImageNameGrid}_${splitText}_${index + 1}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 下载所有切片为ZIP
        async function downloadAllImagesGrid() {
            if (splitImagesGrid.length === 0) return;
            
            const zip = new JSZip();
            const folderName = isSplitModeGrid 
                ? `${currentImageNameGrid}_分割结果` 
                : `${currentImageNameGrid}_切分结果`;
            const folder = zip.folder(folderName);
            
            // 添加所有图片到ZIP
            splitImagesGrid.forEach((image, index) => {
                // 将dataURL转换为二进制数据
                const data = image.dataURL.split(',')[1];
                const fileName = isSplitModeGrid
                    ? `${currentImageNameGrid}_分割_${index + 1}.png`
                    : `${currentImageNameGrid}_切片_${index + 1}.png`;
                folder.file(fileName, data, {base64: true});
            });
            
            // 生成ZIP文件
            const content = await zip.generateAsync({type: 'blob'});
            
            // 下载ZIP文件
            saveAs(content, `${folderName}.zip`);
        }
        
        // 下载网格图片（带网格线的原图）
        function downloadGridImageGrid() {
            if (!originalImageGrid) return;
            
            // 创建Canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置Canvas尺寸为原图尺寸
            canvas.width = originalImageGrid.width;
            canvas.height = originalImageGrid.height;
            
            // 绘制原图
            ctx.drawImage(originalImageGrid, 0, 0);
            
            // 设置线条样式
            const lineColor = isSplitModeGrid ? '#2ecc71' : '#3498db';
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = isSplitModeGrid ? 3 : 2;
            ctx.setLineDash(isSplitModeGrid ? [] : [6, 6]);
            
            // 绘制垂直线
            const colWidth = originalImageGrid.width / colsGrid;
            for (let c = 1; c < colsGrid; c++) {
                ctx.beginPath();
                ctx.moveTo(c * colWidth, 0);
                ctx.lineTo(c * colWidth, originalImageGrid.height);
                ctx.stroke();
            }
            
            // 绘制水平线
            const rowHeight = originalImageGrid.height / rowsGrid;
            for (let r = 1; r < rowsGrid; r++) {
                ctx.beginPath();
                ctx.moveTo(0, r * rowHeight);
                ctx.lineTo(originalImageGrid.width, r * rowHeight);
                ctx.stroke();
            }
            
            // 添加网格标注
            ctx.fillStyle = isSplitModeGrid ? 'rgba(46, 204, 113, 0.8)' : 'rgba(52, 152, 219, 0.8)';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            for (let r = 0; r < rowsGrid; r++) {
                for (let c = 0; c < colsGrid; c++) {
                    const x = c * colWidth + colWidth / 2;
                    const y = r * rowHeight + rowHeight / 2;
                    
                    // 绘制背景圆
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.beginPath();
                    ctx.arc(x, y, 14, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 绘制数字
                    ctx.fillStyle = lineColor;
                    ctx.fillText(r * colsGrid + c + 1, x, y);
                }
            }
            
            // 添加分割模式标记
            if (isSplitModeGrid) {
                ctx.fillStyle = 'rgba(46, 204, 113, 0.9)';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText(`分割模式: ${rowsGrid}×${colsGrid}`, 20, 20);
            }
            
            // 转换为数据URL并下载
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = isSplitModeGrid 
                ? `${currentImageNameGrid}_分割网格图.png` 
                : `${currentImageNameGrid}_网格图.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 重置应用
        function resetAppGrid() {
            // 重置输入
            fileInputGrid.value = '';
            
            // 重置变量为默认值（左右分割）
            originalImageGrid = null;
            splitImagesGrid = [];
            rowsGrid = 1;
            colsGrid = 2;
            isSplitModeGrid = true;
            
            // 重置UI
            rowsSliderGrid.value = 1;
            colsSliderGrid.value = 2;
            rowsDisplayGrid.textContent = 1;
            colsDisplayGrid.textContent = 2;
            rowsValueGrid.textContent = 1;
            colsValueGrid.textContent = 2;
            
            imagePreviewGrid.src = '';
            previewWrapperGrid.style.display = 'none';
            noImageMessageGrid.style.display = 'block';
            splitResultsGrid.style.display = 'none';
            splitImagesContainerGrid.innerHTML = '';
            gridOverlayGrid.innerHTML = '';
            splitInfoGrid.style.display = 'block'; // 显示分割模式信息
            
            splitBtnGrid.disabled = true;
            
            updateGridSizeDisplayGrid();
            updatePresetButtonsGrid();
            updateSplitInfoGrid();
        }
        
        // 更新网格尺寸显示
        function updateGridSizeDisplayGrid() {
            let displayText = `${rowsGrid} × ${colsGrid} 网格`;
            if (isSplitModeGrid) {
                if (rowsGrid === 1 && colsGrid === 2) {
                    displayText = '左右分割 (1×2)';
                } else if (rowsGrid === 2 && colsGrid === 1) {
                    displayText = '上下分割 (2×1)';
                } else if (rowsGrid === 1 && colsGrid === 3) {
                    displayText = '三列分割 (1×3)';
                } else if (rowsGrid === 3 && colsGrid === 1) {
                    displayText = '三行分割 (3×1)';
                } else {
                    displayText = `${rowsGrid}×${colsGrid} 分割`;
                }
            }
            gridSizeDisplayGrid.textContent = displayText;
        }
        
        // 更新预设按钮状态
        function updatePresetButtonsGrid() {
            splitPresetBtns.forEach(btn => {
                const btnRows = parseInt(btn.dataset.rows);
                const btnCols = parseInt(btn.dataset.cols);
                const btnIsSplit = btn.dataset.split === "true";
                
                if (btnRows === rowsGrid && btnCols === colsGrid && btnIsSplit === isSplitModeGrid) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // 更新分割模式信息显示
        function updateSplitInfoGrid() {
            // 判断是否为分割模式（单行或单列）
            const newIsSplitMode = rowsGrid === 1 || colsGrid === 1;
            
            // 如果模式发生变化
            if (newIsSplitMode !== isSplitModeGrid) {
                isSplitModeGrid = newIsSplitMode;
                updateGridSizeDisplayGrid();
                updatePresetButtonsGrid();
            }
            
            // 显示/隐藏分割模式提示
            if (isSplitModeGrid) {
                splitInfoGrid.style.display = 'block';
            } else {
                splitInfoGrid.style.display = 'none';
            }
            
            // 如果已有图片，重新绘制网格
            if (originalImageGrid) {
                drawGridOverlayGrid();
            }
        }
        
        // =================== 初始化 ===================
        document.addEventListener('DOMContentLoaded', () => {
            initFaviconEventListeners();
            initSplitterEventListeners();
            initGridSplitterEventListeners();
            
            // 初始化网格切分器的显示
            updateGridSizeDisplayGrid();
            updateSplitInfoGrid();
            
            // 禁用初始状态下的预览按钮（图片切分器）
            previewSplitBtn.disabled = true;
            splitBtnGrid.disabled = true;
        });
    </script>
</body>
</html>